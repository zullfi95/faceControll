# Настройка WireGuard VPN

Инструкция по настройке VPN туннеля между сервером Hetzner и офисной сетью через роутер Keenetic Runner 4G.

## Зачем нужен VPN?

Терминал DS-K1T343EFWX находится в офисной сети за NAT. Для отправки событий на облачный сервер и получения команд управления нужен защищенный туннель.

```
[Офис - 192.168.1.0/24]          [Hetzner - 46.62.223.55]
   Терминал                  VPN      Сервер
   10.0.0.100 ◄──────────────────────► 10.0.0.1
      ▲                                   ▲
      │                                   │
   Keenetic Router              WireGuard Server
   10.0.0.2
```

---

## Часть 1: Подготовка

### Требования

**На стороне сервера:**
- Ubuntu 22.04 на Hetzner (46.62.223.55)
- WireGuard установлен
- Открыт UDP порт 51820

**На стороне офиса:**
- Роутер Keenetic Runner 4G (KN-2210)
- Обновленная прошивка KeeneticOS
- Компонент "WireGuard VPN" установлен

---

## Часть 2: Генерация ключей

На вашей локальной машине (с установленным WireGuard):

```bash
cd wireguard
bash generate-keys.sh
```

Скрипт создаст:
- `keys/server.key` и `keys/server.pub` - ключи сервера
- `keys/client.key` и `keys/client.pub` - ключи клиента  
- `wg0-server.conf` - готовая конфигурация для сервера
- `wg0-client.conf` - готовая конфигурация для Keenetic

**⚠️ ВАЖНО:** Сохраните файлы ключей в безопасном месте! Не комитьте их в Git!

---

## Часть 3: Настройка сервера (Hetzner)

### Шаг 1: Подключение к серверу

```bash
ssh root@46.62.223.55
```

### Шаг 2: Установка WireGuard (если еще не установлен)

```bash
apt update
apt install -y wireguard
```

### Шаг 3: Копирование конфигурации

**С локальной машины:**
```bash
scp wireguard/wg0-server.conf root@46.62.223.55:/etc/wireguard/wg0.conf
```

**На сервере:**
```bash
# Установка прав доступа
chmod 600 /etc/wireguard/wg0.conf

# Проверка конфигурации
cat /etc/wireguard/wg0.conf
```

### Шаг 4: Включение IP forwarding (опционально)

Если нужен доступ к другим сетям через VPN:

```bash
# Редактирование sysctl.conf
nano /etc/sysctl.conf

# Раскомментируйте или добавьте строку:
net.ipv4.ip_forward=1

# Применение изменений
sysctl -p
```

### Шаг 5: Запуск WireGuard

```bash
# Включение автозапуска
systemctl enable wg-quick@wg0

# Запуск
systemctl start wg-quick@wg0

# Проверка статуса
systemctl status wg-quick@wg0

# Проверка интерфейса
wg show
```

Вы должны увидеть:
```
interface: wg0
  public key: <server_public_key>
  private key: (hidden)
  listening port: 51820

peer: <client_public_key>
  allowed ips: 10.0.0.2/32, 10.0.0.100/32
```

### Шаг 6: Настройка Firewall

```bash
# Разрешение WireGuard порта
ufw allow 51820/udp

# Проверка
ufw status
```

---

## Часть 4: Настройка Keenetic Router

### Шаг 1: Установка компонента WireGuard

1. Откройте веб-интерфейс роутера: http://192.168.1.1 или http://my.keenetic.net
2. Войдите с логином/паролем администратора
3. Перейдите: **Управление → Общие настройки → Обновления и компоненты**
4. Найдите и установите компонент **"WireGuard VPN"**
5. Дождитесь перезагрузки роутера

### Шаг 2: Добавление VPN подключения

1. Перейдите: **Интернет → Другие подключения → WireGuard**
2. Нажмите **"Добавить подключение"**

### Шаг 3: Настройка подключения

**Вкладка "Общие":**
- **Описание:** `Hetzner VPN`
- **Интерфейс:** WireGuard (wg0)
- **Использовать для выхода в интернет:** ❌ (выключено)

**Вкладка "Параметры":**

**Локальные настройки:**
- **Приватный ключ:** (из `wireguard/keys/client.key`)
- **Адрес подключения:** `10.0.0.2/24`
- **MTU:** `1420` (по умолчанию)

**Настройки удаленного узла:**
- **Публичный ключ:** (из `wireguard/keys/server.pub`)
- **Адрес узла:** `46.62.223.55:51820`
- **Разрешенные подсети:** `10.0.0.0/24`
- **Persistent Keepalive:** `25` (секунд)

### Шаг 4: Импорт конфигурации (альтернативный способ)

Если роутер поддерживает импорт конфигурации:

1. Откройте файл `wireguard/wg0-client.conf` на локальной машине
2. Скопируйте содержимое
3. В веб-интерфейсе Keenetic найдите кнопку **"Импорт"** или **"Из файла"**
4. Вставьте конфигурацию

### Шаг 5: Включение подключения

1. Сохраните настройки
2. Включите подключение переключателем
3. Статус должен стать **"Подключено"**

---

## Часть 5: Проверка соединения

### На сервере

```bash
# Проверка интерфейса
wg show

# Должен появиться peer с latest handshake
```

Пример вывода:
```
peer: <client_public_key>
  endpoint: <your_office_ip>:random_port
  allowed ips: 10.0.0.2/32, 10.0.0.100/32
  latest handshake: 10 seconds ago
  transfer: 4.20 KiB received, 3.14 KiB sent
  persistent keepalive: every 25 seconds
```

### С роутера (если есть SSH доступ)

```bash
# Подключение к Keenetic через SSH (если включен)
ssh admin@192.168.1.1

# Проверка подключения
wg show

# Ping сервера
ping 10.0.0.1
```

### С компьютера в офисной сети

```bash
# Ping VPN IP сервера
ping 10.0.0.1

# Если не работает, проверьте маршруты на роутере
```

---

## Часть 6: Настройка маршрутизации на Keenetic

Чтобы устройства в локальной сети могли обращаться к серверу через VPN:

1. Перейдите: **Интернет → Маршруты**
2. Добавьте статический маршрут:
   - **Сеть назначения:** `10.0.0.0/24`
   - **Шлюз:** `10.0.0.2` (IP роутера в VPN)
   - **Интерфейс:** WireGuard (wg0)

---

## Часть 7: Назначение IP терминалу

Теперь нужно, чтобы терминал имел IP `10.0.0.100` в офисной сети:

**Вариант 1: Статический IP на терминале**
1. Зайдите в веб-интерфейс терминала
2. Configuration → Network → Basic Settings
3. Установите:
   - IP: `10.0.0.100`
   - Mask: `255.255.255.0`
   - Gateway: `10.0.0.2` (IP роутера в VPN)

**Вариант 2: DHCP резервация на роутере**
1. В Keenetic: Домашняя сеть → Устройства
2. Найдите терминал по MAC адресу
3. Назначьте фиксированный IP: `10.0.0.100`

---

## Troubleshooting

### Handshake не происходит

**Проверьте:**
1. Порт 51820 UDP открыт на сервере: `netstat -tulpn | grep 51820`
2. Публичные ключи правильно указаны в peer секциях
3. Endpoint правильный: `46.62.223.55:51820`

**Действия:**
```bash
# На сервере
systemctl restart wg-quick@wg0
wg show

# На Keenetic
# Отключите и включите подключение заново
```

### Ping не проходит

**Проверьте:**
1. IP forwarding включен на сервере: `sysctl net.ipv4.ip_forward`
2. Firewall разрешает трафик: `ufw status`
3. AllowedIPs правильно настроены

**Действия:**
```bash
# Проверка маршрутов на сервере
ip route show

# Должен быть маршрут: 10.0.0.0/24 dev wg0
```

### Соединение обрывается

**Причина:** NAT закрывает соединение из-за неактивности

**Решение:** Убедитесь, что PersistentKeepalive установлен на клиенте (25 секунд)

```ini
[Peer]
...
PersistentKeepalive = 25
```

### Терминал не может достучаться до сервера

**Проверьте:**
1. Терминал имеет маршрут до 10.0.0.0/24 через роутер
2. На роутере правильно настроена маршрутизация
3. Firewall на роутере не блокирует трафик

**Тест:**
```bash
# С компьютера в офисе
ping 10.0.0.1
curl http://10.0.0.1/api/users/

# Должен вернуть список пользователей
```

---

## Мониторинг VPN

### На сервере

```bash
# Непрерывный мониторинг
watch -n 1 wg show

# Логи
journalctl -u wg-quick@wg0 -f
```

### На Keenetic

Веб-интерфейс → Интернет → Другие подключения → WireGuard

Проверяйте:
- ✅ Статус: Подключено
- ✅ Последний handshake: недавно (< 2 минут)
- ✅ Transfer: данные передаются

---

## Следующие шаги

После успешной настройки VPN:

1. [Настройка терминала Hikvision](TERMINAL_SETUP.md)
2. Добавление устройства в веб-интерфейсе: `http://46.62.223.55/settings`

---

## Дополнительные ресурсы

- [WireGuard Official Documentation](https://www.wireguard.com/)
- [Keenetic WireGuard Guide](https://help.keenetic.com/hc/ru/articles/360021400279)

