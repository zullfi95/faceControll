# –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ Hikvision

## ‚úÖ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ

**Endpoint:** `POST /api/users/`

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "hikvision_id": "100222",
  "full_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "department": "1"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": 2,
  "hikvision_id": "100222",
  "full_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "department": "1",
  "is_active": true,
  "photo_path": null,
  "synced_to_device": false,
  "created_at": "2025-12-10T23:45:00"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

---

### –®–∞–≥ 2: –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

**Endpoint:** `POST /api/devices/{device_id}/start-face-capture`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `POST /ISAPI/AccessControl/CaptureFaceData` –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
2. –¢–µ—Ä–º–∏–Ω–∞–ª –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –ª–∏—Ü–∞
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥—ä—è–≤–ª—è–µ—Ç –ª–∏—Ü–æ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É** (–≤ —Ç–µ—á–µ–Ω–∏–µ 5-10 —Å–µ–∫—É–Ω–¥)
4. –¢–µ—Ä–º–∏–Ω–∞–ª —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª `web_face_enrollpic.jpg` –≤ `/LOCALS/pic/`
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è URL: `https://192.168.1.67/LOCALS/pic/web_face_enrollpic.jpg@WEB000000000020`

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "photo_path": "/uploads/100222_xxx.jpg",
  "message": "Face captured successfully",
  "face_data_url": "https://192.168.1.67/LOCALS/pic/web_face_enrollpic.jpg@WEB000000000020"
}
```

**–í–∞–∂–Ω–æ:** –§–∞–π–ª `web_face_enrollpic.jpg` —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

---

### –®–∞–≥ 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º

**Endpoint:** `POST /api/users/{user_id}/sync-to-device`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —á–µ—Ä–µ–∑ `POST /ISAPI/AccessControl/UserInfo/Record`
2. –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ `PUT /ISAPI/Intelligent/FDLib/FDSetUp` —Å URL `web_face_enrollpic.jpg`

**–ó–∞–ø—Ä–æ—Å FDSetUp:**
```
PUT /ISAPI/Intelligent/FDLib/FDSetUp?format=json
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...

------WebKitFormBoundary...
Content-Disposition: form-data; name="FaceDataRecord"

{"faceLibType":"blackFD","FDID":"1","FPID":"100222","faceURL":"https://192.168.1.67/LOCALS/pic/web_face_enrollpic.jpg@WEB000000000020"}
------WebKitFormBoundary...--
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "statusCode": 1,
  "statusString": "OK",
  "subStatusCode": "ok"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º —Ñ–æ—Ç–æ!

---

## üìã –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"
2. –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É:
   - ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `100222`)
   - –§–ò–û (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤`)
   - –û—Ç–¥–µ–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –ù–∞–∂–∞—Ç—å "–ó–∞—Ö–≤–∞—Ç–∏—Ç—å —Ñ–æ—Ç–æ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
5. **–ü—Ä–µ–¥—ä—è–≤–∏—Ç—å –ª–∏—Ü–æ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É** –≤ —Ç–µ—á–µ–Ω–∏–µ 5-10 —Å–µ–∫—É–Ω–¥
6. –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è "‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ!"
7. –ù–∞–∂–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
8. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –°–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
   - –°–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
   - –ü—Ä–∏–≤—è–∂–µ—Ç —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ FDSetUp

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ñ–∞–π–ª–æ–º

1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"
2. –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
4. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Ñ–∞–π–ª–æ–º (–≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª)
5. –ù–∞–∂–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
6. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –°–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
   - –ó–∞–≥—Ä—É–∑–∏—Ç —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –°–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
   - **–ù–û:** –§–æ—Ç–æ –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è (–≤—Å–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç)

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ —Ñ–∞–π–ª–æ–º, —Ñ–æ—Ç–æ –Ω–µ –±—É–¥–µ—Ç –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞—Ö–≤–∞—Ç —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç CaptureFaceData + FDSetUp?

1. **CaptureFaceData** —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª **–Ω–∞ —Å–∞–º–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ** –≤ `/LOCALS/pic/web_face_enrollpic.jpg`
2. –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ URL: `https://192.168.1.67/LOCALS/pic/web_face_enrollpic.jpg@WEB000000000020`
3. **FDSetUp** –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π URL —Ç–µ—Ä–º–∏–Ω–∞–ª–∞** –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ñ–æ—Ç–æ
4. –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É URL - –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–π–ª

### –ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã?

- **pictureUpload** - —Ç–µ—Ä–º–∏–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"notSupport"` (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
- **FaceDataRecord —Å URL** - —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É URL (`urlDownloadFail`)
- **FaceDataRecord —Å base64** - —Ç–µ—Ä–º–∏–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ (`badJsonContent`)
- **–ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ /LOCALS/** - PUT –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (`405 Method Not Allowed`)

---

## ‚úÖ –ò—Ç–æ–≥

**–†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å:**
1. CaptureFaceData ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
2. FDSetUp ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª!**

---

## üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ –Ω–µ—Ä–∞–±–æ—á–∏–µ –º–µ—Ç–æ–¥—ã

–ò–∑ –∫–æ–¥–∞ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

1. **`upload_user_with_face_multipart`** - `POST /ISAPI/Intelligent/FDLib/pictureUpload`
   - –¢–µ—Ä–º–∏–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"notSupport"` (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)

2. **`add_face_data_record_with_photo`** - `POST /ISAPI/Intelligent/FDLib/FaceDataRecord` —Å –±–∏–Ω–∞—Ä–Ω—ã–º —Ñ–æ—Ç–æ
   - –¢–µ—Ä–º–∏–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ (`badJsonFormat`, `badJsonContent`)

3. **`upload_user_face_photo`** - –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `UserInfoDetail/Picture`
   - –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º

4. **–ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ `/LOCALS/pic/enrlFace/`** - `PUT` –∑–∞–ø—Ä–æ—Å
   - –¢–µ—Ä–º–∏–Ω–∞–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `405 Method Not Allowed`

**–í—Å–µ —ç—Ç–∏ –º–µ—Ç–æ–¥—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ `hikvision_client.py` –∏ `main.py` –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∫–æ–¥–∞ –∏ –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—É—Ç–∞–Ω–∏—Ü—ã.**

