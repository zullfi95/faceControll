# Настройка терминала Hikvision DS-K1T343EFWX

Пошаговая инструкция по настройке терминала распознавания лиц для работы с системой.

## Предварительные требования

- ✅ Терминал DS-K1T343EFWX подключен к сети
- ✅ VPN туннель настроен и работает
- ✅ Терминал доступен по IP (например, 192.168.1.100)
- ✅ Логин/пароль администратора терминала известны

---

## Часть 1: Базовая настройка терминала

### Шаг 1: Подключение к веб-интерфейсу

1. Откройте браузер (Chrome/Firefox)
2. Введите IP адрес терминала: `http://192.168.1.100`
3. Войдите с учетными данными администратора:
   - **Логин:** `admin`
   - **Пароль:** (ваш пароль)

> **Примечание:** Если браузер запрашивает установку плагина, установите Web Components или используйте совместимый браузер.

### Шаг 2: Обновление прошивки (рекомендуется)

1. Перейдите: **Configuration → System → Maintenance → Upgrade**
2. Проверьте текущую версию прошивки
3. Если доступна новая версия:
   - Скачайте с сайта Hikvision
   - Загрузите через **Browse → Upgrade**
   - Дождитесь перезагрузки терминала

### Шаг 3: Настройка сети

1. Перейдите: **Configuration → Network → Basic Settings**
2. Настройте IP адрес:

**Вариант A: Статический IP в VPN сети**
```
IPv4 Address: 10.0.0.100
IPv4 Subnet Mask: 255.255.255.0
IPv4 Default Gateway: 10.0.0.2
Preferred DNS Server: 8.8.8.8
Alternate DNS Server: 1.1.1.1
```

**Вариант B: DHCP (если роутер выдает IP)**
```
Obtain an IP address automatically: ✅
```

3. Нажмите **Save**
4. Терминал перезагрузится

> **Важно:** После смены IP подключайтесь по новому адресу!

---

## Часть 2: Включение ISAPI

ISAPI необходим для удаленного управления терминалом через веб-интерфейс системы.

### Шаг 1: Включение HTTP API

1. Перейдите: **Configuration → Network → Advanced Settings → Integration Protocol**
2. Убедитесь, что включено:
   - ✅ **Enable Hikvision-CGI**
   - ✅ **Enable ISAPI**

### Шаг 2: Создание пользователя API (рекомендуется)

Для безопасности создайте отдельного пользователя для API:

1. Перейдите: **Configuration → System → User Management**
2. Нажмите **Add**
3. Заполните:
   - **User Name:** `api_user`
   - **Password:** (надежный пароль)
   - **Confirm Password:** (повторите)
   - **Level:** `Operator` (или `Administrator` для полного доступа)
   - **User Type:** `Normal`
4. В разделе **Permission** выберите:
   - ✅ Remote Configuration
   - ✅ Remote Parameters Settings
   - ✅ Access Control Management
5. Нажмите **OK**

> **Примечание:** Этого пользователя вы укажете в настройках устройства в веб-интерфейсе системы.

---

## Часть 3: Настройка HTTP Listening

HTTP Listening позволяет терминалу отправлять события (проходы) на сервер.

### Шаг 1: Открытие настроек

1. Перейдите: **Configuration → Network → Advanced Settings → HTTP Listening**

### Шаг 2: Заполнение параметров

```
Event Alarm IP/Domain Name: 10.0.0.1
URL: /events/webhook
Port: 8000
Protocol: HTTP (или HTTPS если настроен SSL)
```

**Объяснение:**
- `10.0.0.1` - IP адрес сервера в VPN сети
- `/events/webhook` - endpoint для приема событий
- `8000` - порт backend (проксируется через nginx на 80)
- `HTTP` - протокол (внутри VPN безопасно)

### Шаг 3: Сохранение

1. Нажмите **Save**
2. Проверьте настройки еще раз

---

## Часть 4: Настройка событий

### Шаг 1: Выбор типов событий

1. Перейдите: **Configuration → Event → Basic Event**
2. Настройте события доступа:

**Access Control Event:**
- ✅ **Enable Event Notification**
- ✅ **Send to HTTP Listening**

**Типы событий для отправки:**
- ✅ Face Recognition Passed (распознавание лица)
- ✅ Card Swiped (карта)
- ✅ Fingerprint Passed (отпечаток)

### Шаг 2: Настройка распознавания лиц

1. Перейдите: **Configuration → Access Control → Authentication**
2. Настройте:
   - **Authentication Mode:** Face Recognition
   - **Match Threshold:** 70-80 (рекомендуется 75)
   - **Liveness Detection:** Enable (если поддерживается)

---

## Часть 5: Проверка отправки событий

### Тест 1: Проверка подключения

**На сервере:**
```bash
# Подключение к серверу
ssh root@46.62.223.55

# Просмотр логов backend
cd /opt/face-access-control
docker-compose logs -f backend
```

**На терминале:**
1. Приложите зарегистрированную карту/лицо к терминалу
2. Терминал издаст звук и покажет результат
3. В логах backend должна появиться запись о событии

### Тест 2: Проверка формата событий

В логах вы должны увидеть:
```json
{
  "ipAddress": "10.0.0.100",
  "dateTime": "2024-12-04T12:34:56",
  "AccessControllerEvent": {
    "majorEventType": 5,
    "subEventType": 75,
    "employeeNoString": "1001",
    "name": "Иван Иванов"
  }
}
```

**Коды событий:**
- `majorEventType: 5` - Event
- `subEventType: 75` - Face authentication passed
- `subEventType: 1` - Card passed
- `subEventType: 25` - Fingerprint passed

---

## Часть 6: Настройка API ключа (Security)

Для безопасности система требует API ключ в заголовке запросов от терминала.

### Проблема

Hikvision терминалы **не поддерживают** отправку кастомных заголовков в HTTP Listening.

### Решение 1: Отключить проверку (только для тестирования)

В `.env` файле на сервере:
```env
WEBHOOK_API_KEY=
```
Пустое значение отключит проверку.

### Решение 2: Nginx pre-authentication

Добавьте API ключ в nginx на основе IP терминала:

```nginx
location /events/webhook {
    # Добавление X-API-Key для терминала
    if ($remote_addr = "10.0.0.100") {
        set $api_key "ваш_webhook_api_key";
    }
    
    proxy_set_header X-API-Key $api_key;
    proxy_pass http://backend:8000/events/webhook;
}
```

### Решение 3: Использовать IP фильтрацию

Разрешить доступ к webhook только с IP терминала:

```nginx
location /events/webhook {
    allow 10.0.0.100;  # Терминал
    deny all;
    
    proxy_pass http://backend:8000/events/webhook;
}
```

---

## Часть 7: Регистрация пользователей

После настройки терминала можно добавлять пользователей:

### Через веб-интерфейс системы (рекомендуется)

1. Откройте: `http://46.62.223.55/settings`
2. Добавьте устройство:
   - **IP:** `10.0.0.100` (VPN IP терминала!)
   - **Логин:** `api_user` (или `admin`)
   - **Пароль:** (ваш пароль)
3. Проверьте соединение

4. Перейдите на страницу "Сотрудники"
5. Добавьте сотрудника:
   - **ID:** только ASCII символы (`a-zA-Z0-9_-`), максимум 32 символа
   - **ФИО:** полное имя
   - **Отдел:** (опционально)
6. Загрузите фото лица (JPEG, PNG, до 5 MB)
7. Нажмите "Синхронизировать с терминалом"
8. Дождитесь завершения (3-7 секунд)

> **Важно:** Используйте VPN IP терминала (`10.0.0.100`), а не локальный IP!

### Через веб-интерфейс терминала (вручную)

1. Перейдите: **Access Control → User Management**
2. Нажмите **Add**
3. Заполните:
   - **Employee No:** `1001`
   - **Name:** Имя сотрудника
4. В разделе **Face** нажмите **Add Face**
5. Загрузите фото или используйте камеру терминала
6. Сохраните

---

## Troubleshooting

### Терминал не отправляет события

**Проверьте:**
1. ✅ HTTP Listening настроен правильно
2. ✅ Терминал может достучаться до сервера:
   ```bash
   # С терминала (если есть SSH):
   ping 10.0.0.1
   ```
3. ✅ События включены в настройках
4. ✅ Пользователь зарегистрирован на терминале

**Действия:**
- Перезагрузите терминал
- Проверьте логи backend
- Попробуйте отправить тестовое событие

### Не могу добавить пользователя через API

**Проверьте:**
1. ✅ ISAPI включен
2. ✅ Логин/пароль API пользователя правильные
3. ✅ Пользователь имеет права на Access Control Management

**Тест соединения:**
```bash
# С сервера
curl -u api_user:password \
  --digest \
  http://10.0.0.100/ISAPI/System/deviceInfo

# Должен вернуть информацию об устройстве
```

### Низкая точность распознавания

**Улучшение:**
1. Используйте качественные фото (высокое разрешение, анфас)
2. Настройте Match Threshold (70-80%)
3. Включите Liveness Detection для защиты от фото
4. Обеспечьте хорошее освещение в месте установки терминала

### Терминал не отвечает

**Действия:**
1. Проверьте подключение к сети
2. Ping терминала
3. Перезагрузите терминал (отключите питание на 10 сек)
4. Сброс к заводским настройкам (кнопка reset на корпусе)

---

## Дополнительные возможности

### Расписание доступа

1. **Configuration → Access Control → Schedule**
2. Создайте расписания (например, рабочие часы)
3. Привяжите к пользователям/группам

### Звуковые уведомления

1. **Configuration → Audio Management**
2. Настройте звуки для разных событий
3. Загрузите кастомные аудиофайлы

### Отображение информации

1. **Configuration → Display Settings**
2. Настройте, что показывать на экране:
   - Имя пользователя
   - Employee No
   - Время
   - Кастомное сообщение

---

## Следующие шаги

- [Руководство пользователя](USER_GUIDE.md) - работа с веб-интерфейсом системы
- [Troubleshooting](DEPLOYMENT.md#troubleshooting) - решение проблем

---

## Полезные ссылки

- [Hikvision Technical Support](https://www.hikvision.com/en/support/)
- [DS-K1T343EFWX Datasheet](https://www.hikvision.com/en/products/)
- [ISAPI Documentation](https://www.hikvision.com/en/support/download/sdk/)

