FROM node:18-alpine

WORKDIR /app

# Копируем package.json и устанавливаем зависимости
COPY package*.json ./
RUN npm install

# Копируем конфигурационные файлы
COPY vite.config.js ./
COPY tailwind.config.js ./
COPY postcss.config.js ./
COPY index.html ./

# Копируем исходники (будут перезаписаны volume)
COPY src ./src

# Устанавливаем nginx
RUN apk add --no-cache nginx

# Создаем полную конфигурацию nginx для dev режима
# В Alpine nginx нужно создать полный nginx.conf с map директивой
RUN mkdir -p /etc/nginx/conf.d
COPY nginx.conf.dev /etc/nginx/nginx.conf

# Создаем директорию для собранных файлов
RUN mkdir -p /app/dist

# Первоначальная сборка
RUN npm run build

# Запускаем автоматическую пересборку в фоне и nginx
CMD sh -c "npm run watch & nginx -g 'daemon off;'"

