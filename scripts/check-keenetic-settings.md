# Проверка настроек Keenetic для WireGuard Site-to-Site VPN

## Проблема
Пакеты уходят с сервера (192.168.78.1) на устройство (192.168.1.122), но ответы не возвращаются.

## Что нужно проверить на Keenetic

### 1. Настройки WireGuard клиента

**Путь:** Интернет → VPN-клиенты → WireGuard → [Ваш VPN-профиль]

Проверьте следующие параметры:

#### ✅ Обязательные настройки:

1. **Endpoint (Сервер):**
   - Должен быть: `46.62.223.55:51820`
   - Проверьте, что порт открыт и доступен

2. **Public Key сервера:**
   - Должен совпадать с PublicKey на сервере
   - На сервере: `6i8kYOl7CwwfqMJ/WlNyyBFSsWNf5MLmaNs/lI0u20U=`

3. **Private Key клиента:**
   - Должен соответствовать PublicKey в конфигурации сервера
   - На сервере ожидается: `8aAOGZeZ95jwAEkRjJRDEDL58Yp/OCYLgkIsIHoXfhc=`

4. **Allowed IPs (Разрешенные IP):**
   - Должно быть: `192.168.78.0/24` или `192.168.78.1/32`
   - **ВАЖНО:** НЕ должно быть `0.0.0.0/0` (это отправит весь трафик через VPN)

5. **"Use for accessing the Internet" (Использовать для доступа в Интернет):**
   - **ДОЛЖНО БЫТЬ ОТКЛЮЧЕНО** ❌
   - Если включено, весь интернет-трафик пойдет через VPN

#### ✅ Критически важные настройки:

6. **"Allow access to home network" / "Доступ к домашней сети" / "Маршрутизация подсети":**
   - **ДОЛЖНО БЫТЬ ВКЛЮЧЕНО** ✅
   - Это позволяет серверу обращаться к устройствам в локальной сети Keenetic

7. **"Route traffic for specific networks" / "Маршрутизировать трафик для конкретных сетей":**
   - Если есть такая опция, добавьте: `192.168.78.0/24`

### 2. Статические маршруты

**Путь:** Интернет → Маршрутизация → Статические маршруты

Добавьте статический маршрут (если опция "Allow access to home network" недоступна):

- **Сеть назначения:** `192.168.78.0/24`
- **Шлюз/Интерфейс:** WireGuard интерфейс (или IP `192.168.78.1`)
- **Метрика:** `10` (или меньше, чем у других маршрутов)

### 3. Проверка подключения

**Путь:** Интернет → VPN-клиенты → WireGuard → [Ваш VPN-профиль] → Статус

Проверьте:
- ✅ Статус: "Подключено" / "Connected"
- ✅ Время подключения: должно быть недавним
- ✅ Переданные данные: должны увеличиваться

### 4. Настройки файрвола Keenetic

**Путь:** Интернет → Межсетевой экран → Правила

Убедитесь, что нет правил, блокирующих трафик:
- От `192.168.78.0/24` к `192.168.1.0/24`
- От `192.168.1.0/24` к `192.168.78.0/24`

### 5. Проверка на устройстве Hikvision (192.168.1.122)

Убедитесь, что:
- Шлюз по умолчанию: `192.168.1.1` (IP Keenetic)
- Устройство может пинговать Keenetic: `ping 192.168.1.1`

## Диагностика

### Проверка с сервера:

```bash
# Проверка WireGuard статуса
ssh root@46.62.223.55 'wg show'

# Проверка маршрутов
ssh root@46.62.223.55 'ip route | grep 192.168.1'

# Проверка доступности устройства
ssh root@46.62.223.55 'ping -c 3 192.168.1.122'

# Мониторинг трафика
ssh root@46.62.223.55 'tcpdump -i wg0 -n host 192.168.1.122'
```

### Ожидаемый результат:

1. **wg show** должен показывать:
   - `latest handshake: [недавнее время]` (не "(none)")
   - `transfer: [данные получены и отправлены]`

2. **ip route** должен показывать:
   - `192.168.1.0/24 dev wg0 scope link`

3. **ping** должен показывать:
   - `3 packets transmitted, 3 received, 0% packet loss`

## Если проблема не решена

1. **Перезапустите WireGuard на Keenetic:**
   - Отключите и включите VPN-профиль
   - Или перезагрузите Keenetic

2. **Проверьте логи на Keenetic:**
   - Путь: Система → Журнал событий
   - Ищите ошибки, связанные с WireGuard или маршрутизацией

3. **Проверьте версию прошивки Keenetic:**
   - Убедитесь, что используется актуальная версия с поддержкой WireGuard

4. **Проверьте настройки NAT на Keenetic:**
   - Убедитесь, что NAT не блокирует обратный трафик

## Контактная информация для диагностики

Если проблема не решается, соберите следующую информацию:

1. Скриншоты настроек WireGuard на Keenetic
2. Вывод `wg show` с сервера
3. Вывод `ip route` с сервера
4. Логи Keenetic (Система → Журнал событий)
5. Версия прошивки Keenetic

