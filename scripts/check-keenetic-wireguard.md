# Пошаговая инструкция: Проверка настроек WireGuard на Keenetic

## Шаг 1: Вход в веб-интерфейс Keenetic

1. Откройте браузер и перейдите по адресу: `http://192.168.1.1`
2. Войдите в систему (используйте ваши учетные данные)

## Шаг 2: Переход к настройкам WireGuard

**Путь:** `Интернет` → `VPN-клиенты` → `WireGuard`

Или через меню:
- Нажмите на иконку "Интернет" (глобус) в левом меню
- Выберите "VPN-клиенты"
- Найдите и откройте "WireGuard"

## Шаг 3: Проверка настроек VPN-профиля

Найдите ваш VPN-профиль (подключение к серверу `46.62.223.55`) и откройте его для редактирования.

### ✅ Проверьте следующие параметры:

#### 1. **Endpoint (Сервер):**
- Должно быть: `46.62.223.55:51820`
- Если отличается, исправьте

#### 2. **Public Key сервера:**
- Должно быть: `6i8kYOl7CwwfqMJ/WlNyyBFSsWNf5MLmaNs/lI0u20U=`
- Это публичный ключ сервера

#### 3. **Private Key клиента:**
- Должно быть: `8MtZb+P5wvA/WhhdL2bFTIh+bOKkTuCJUwr6/eSPlkU=`
- Это приватный ключ клиента (Keenetic)

#### 4. **Address (Адрес):**
- Должно быть: `192.168.78.2/32`
- Это VPN IP адрес Keenetic

#### 5. **Allowed IPs (Разрешенные IP):**
- Должно быть: `192.168.78.0/24` или `192.168.78.1/32`
- **КРИТИЧЕСКИ ВАЖНО:** НЕ должно быть `0.0.0.0/0`!
- Если стоит `0.0.0.0/0`, замените на `192.168.78.0/24`

#### 6. **"Use for accessing the Internet" (Использовать для доступа в Интернет):**
- **ДОЛЖНО БЫТЬ ОТКЛЮЧЕНО** ❌
- Если включено, отключите!

#### 7. **"Allow access to home network" / "Доступ к домашней сети" / "Маршрутизация подсети":**
- **ДОЛЖНО БЫТЬ ВКЛЮЧЕНО** ✅
- Это самая важная настройка для site-to-site VPN!
- Если этой опции нет, см. "Альтернативное решение" ниже

#### 8. **Persistent Keepalive:**
- Должно быть: `25` секунд
- Это помогает поддерживать соединение активным

## Шаг 4: Проверка статуса подключения

В том же разделе WireGuard проверьте статус:

- ✅ Статус должен быть: "Подключено" / "Connected"
- ✅ Время последнего подключения должно быть недавним
- ✅ Переданные данные должны увеличиваться

Если статус "Отключено", нажмите "Подключить" / "Connect"

## Шаг 5: Проверка статических маршрутов (если нужно)

**Если опция "Allow access to home network" недоступна:**

1. Перейдите: `Интернет` → `Маршрутизация` → `Статические маршруты`
2. Добавьте новый маршрут:
   - **Сеть назначения:** `192.168.78.0/24`
   - **Шлюз/Интерфейс:** Выберите WireGuard интерфейс (обычно называется `wg0` или похоже)
   - **Метрика:** `10`
3. Сохраните изменения

## Шаг 6: Проверка файрвола

1. Перейдите: `Интернет` → `Межсетевой экран` → `Правила`
2. Убедитесь, что нет правил, блокирующих:
   - Трафик от `192.168.78.0/24` к `192.168.1.0/24`
   - Трафик от `192.168.1.0/24` к `192.168.78.0/24`

## Шаг 7: Перезапуск VPN (если изменили настройки)

1. Вернитесь в `Интернет` → `VPN-клиенты` → `WireGuard`
2. Отключите VPN-профиль
3. Подождите 5 секунд
4. Включите VPN-профиль снова

## Шаг 8: Проверка работы

После настройки проверьте с сервера:

```bash
ssh root@46.62.223.55 'ping -c 3 192.168.1.122'
```

Ожидаемый результат:
```
PING 192.168.1.122 (192.168.1.122) 56(84) bytes of data.
64 bytes from 192.168.1.122: icmp_seq=1 ttl=64 time=XX ms
64 bytes from 192.168.1.122: icmp_seq=2 ttl=64 time=XX ms
64 bytes from 192.168.1.122: icmp_seq=3 ttl=64 time=XX ms

--- 192.168.1.122 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss
```

## Частые проблемы и решения

### Проблема 1: "Allow access to home network" не найдена

**Решение:**
- Проверьте версию прошивки Keenetic (должна быть актуальной)
- Используйте статические маршруты (см. Шаг 5)
- Или найдите опцию в другом месте: `Интернет` → `Дополнительно` → `Маршрутизация`

### Проблема 2: VPN подключается, но пакеты не проходят

**Решение:**
1. Проверьте, что "Use for accessing the Internet" отключено
2. Проверьте, что AllowedIPs = `192.168.78.0/24` (не `0.0.0.0/0`)
3. Добавьте статический маршрут (см. Шаг 5)
4. Перезапустите VPN

### Проблема 3: Статус "Отключено" и не подключается

**Решение:**
1. Проверьте правильность PublicKey и Endpoint
2. Проверьте, что порт 51820 открыт на сервере
3. Проверьте логи: `Система` → `Журнал событий`

## Контрольный список

Перед завершением проверьте:

- [ ] Endpoint правильный: `46.62.223.55:51820`
- [ ] PublicKey сервера правильный
- [ ] PrivateKey клиента правильный
- [ ] Address = `192.168.78.2/32`
- [ ] AllowedIPs = `192.168.78.0/24` (НЕ `0.0.0.0/0`)
- [ ] "Use for accessing the Internet" = **ОТКЛЮЧЕНО** ❌
- [ ] "Allow access to home network" = **ВКЛЮЧЕНО** ✅
- [ ] Статус VPN = "Подключено"
- [ ] Статический маршрут добавлен (если нужно)
- [ ] Ping с сервера работает

## После настройки

После правильной настройки вы должны увидеть:

1. ✅ Ping с сервера на устройство работает
2. ✅ Backend может подключиться к устройству Hikvision
3. ✅ Webhook события приходят на сервер
4. ✅ Операции (добавление пользователя, захват фото) работают

Если что-то не работает, проверьте логи на сервере:
```bash
ssh root@46.62.223.55 'docker logs facecontroll-backend-1 --tail 50'
```

